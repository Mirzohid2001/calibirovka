{% extends 'calibration/base.html' %}

{% load static %}

{% block title %}Калькулятор перекачки из резервуаров{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">
                    <i class="bi bi-calculator me-2"></i>
                    Калькулятор перекачки из резервуаров
                </h3>
            </div>
            <div class="card-body">
                <form id="calibrationForm" method="post">
                    {% csrf_token %}
                    
                    <!-- Tank Selection -->
                    <div class="mb-3">
                        <label for="tank" class="form-label">
                            <i class="bi bi-building me-1"></i>
                            Выберите резервуар:
                        </label>
                        <select class="form-select" id="tank" name="tank" required aria-describedby="tankHelp">
                            <option value="">-- Выберите резервуар --</option>
                            {% for tank in tanks %}
                                <option value="{{ tank.id }}" 
                                        data-capacity="{{ tank.capacity_liters }}"
                                        data-height="{{ tank.height_cm }}"
                                        {% if tank.id|stringformat:"s" == request.POST.tank %}selected{% endif %}>
                                    {{ tank.name }} ({{ tank.capacity_liters|floatformat:0 }}L, {{ tank.height_cm }}см)
                                </option>
                            {% endfor %}
                        </select>
                        <div id="tankHelp" class="form-text">Выберите резервуар из списка</div>
                    </div>

                    <!-- Product Selection -->
                    <div class="mb-3">
                        <label for="product" class="form-label">
                            <i class="bi bi-droplet me-1"></i>
                            Выберите продукт:
                        </label>
                        <select class="form-select" id="product" name="product" required aria-describedby="productHelp">
                            <option value="">-- Выберите продукт --</option>
                            {% for product in products %}
                                <option value="{{ product.id }}"
                                        {% if product.id|stringformat:"s" == request.POST.product %}selected{% endif %}>
                                    {{ product.name }} - {{ product.description }}
                                </option>
                            {% endfor %}
                        </select>
                        <div id="productHelp" class="form-text">Выберите продукт</div>
                    </div>

                    <!-- Density Input -->
                    <div class="mb-3">
                        <label for="density" class="form-label">
                            <i class="bi bi-speedometer me-1"></i>
                            Плотность (кг/л):
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="density" 
                               name="density_kg_per_liter" 
                               placeholder="Например: 0.8500"
                               value="{{ request.POST.density_kg_per_liter }}"
                               inputmode="decimal" pattern="[0-9]*[\.,]?[0-9]+" aria-describedby="densityHelp" required>
                        <div id="densityHelp" class="form-text">
                            <small class="text-muted">
                                <strong>Важно:</strong> Плотность сильно зависит от температуры. Используйте фактическую измеренную плотность для точных расчетов.
                            </small>
                        </div>
                    </div>

                    <!-- Common Density Reference -->
                    <!-- <div class="mb-3">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle me-1"></i>Справочные значения плотности при 15°C:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="mb-0 small">
                                        <li>Сырая нефть: 0.8500 кг/л</li>
                                        <li>Бензин: 0.7200 кг/л</li>
                                        <li>Дизельное топливо: 0.8300 кг/л</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="mb-0 small">
                                        <li>Авиационное топливо (керосин): 0.8100 кг/л</li>
                                        <li>Мазут: 0.9500 кг/л</li>
                                        <li>Вода: 1.0000 кг/л</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div> -->

                    <!-- Initial Height -->
                    <div class="mb-3">
                        <label for="initial_height" class="form-label">
                            <i class="bi bi-rulers me-1"></i>
                            Текущая высота жидкости (см):
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="initial_height" 
                               name="initial_height_cm" 
                               placeholder="Например: 125.5"
                               value="{{ request.POST.initial_height_cm }}"
                               inputmode="decimal" pattern="[0-9]*[\.,]?[0-9]+" required>
                    </div>

                    <!-- Transfer Weight -->
                    <div class="mb-3">
                        <label for="transfer_weight" class="form-label">
                            <i class="bi bi-arrow-down-circle me-1"></i>
                            Вес жидкости для откачки (кг):
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="transfer_weight" 
                               name="transfer_weight_kg" 
                               placeholder="Например: 15000.25"
                               value="{{ request.POST.transfer_weight_kg }}"
                               inputmode="decimal" pattern="[0-9]*[\.,]?[0-9]+" required>
                        <div class="form-text">
                            <small class="text-muted">
                                Введите вес жидкости, которую необходимо откачать из резервуара.
                            </small>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-calculator me-2"></i>
                            Рассчитать остаток в резервуаре
                        </button>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show modal if result exists
    {% if result %}
    const resultHtml = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="bi bi-building me-1"></i>Резервуар:</h6>
                <p class="mb-2">{{ result.tank_name }}</p>
                
                <h6><i class="bi bi-droplet me-1"></i>Продукт:</h6>
                <p class="mb-2">{{ result.product_name }}</p>
                
                <h6><i class="bi bi-speedometer me-1"></i>Плотность:</h6>
                <p class="mb-2">{{ result.density|floatformat:4 }} кг/л</p>
            </div>
            <div class="col-md-6">
                <h6><i class="bi bi-rulers me-1"></i>Начальная высота:</h6>
                <p class="mb-2">{{ result.initial_height|floatformat:2 }} см</p>
                
                <h6><i class="bi bi-arrow-down-circle me-1"></i>Вес откачки:</h6>
                <p class="mb-2">{{ result.transfer_weight|floatformat:2 }} кг</p>
                
                <h6><i class="bi bi-arrows-vertical me-1"></i>Высота после откачки:</h6>
                <p class="mb-2 h5 text-primary">{{ result.final_height|floatformat:2 }} см</p>
            </div>
        </div>
        
        <hr>
        
        <div class="row">
            <div class="col-md-6">
                <h6><i class="bi bi-droplet-half me-1"></i>Начальный объем:</h6>
                <p>{{ result.initial_volume|floatformat:2 }} л</p>
            </div>
            <div class="col-md-6">
                <h6><i class="bi bi-droplet me-1"></i>Объем после откачки:</h6>
                <p>{{ result.final_volume|floatformat:2 }} л</p>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h6><i class="bi bi-arrow-down-circle me-1"></i>Откачанный объем:</h6>
                <p>{{ result.volume_removed|floatformat:2 }} л</p>
            </div>
            <div class="col-md-6">
                <h6><i class="bi bi-percent me-1"></i>Заполнение резервуара:</h6>
                <p>{{ result.fill_percentage|floatformat:1 }}%</p>
            </div>
        </div>
        
        <div class="alert alert-success mt-3">
            <i class="bi bi-lightbulb me-2"></i>
            <strong>Интерполяция:</strong> Используется 
            {% if result.interpolation_method == 'linear' %}
                линейная интерполяция
            {% elif result.interpolation_method == 'spline' %}
                сплайн-интерполяция (кубическая)
            {% else %}
                {{ result.interpolation_method }}
            {% endif %}
            для точных расчетов на основе калибровочной таблицы резервуара.
        </div>
    `;
    document.getElementById('resultsModalBody').innerHTML = resultHtml;
    // Change modal header color for this calculator
    const modalHeader = document.querySelector('#resultsModal .modal-header');
    if (modalHeader) {
        modalHeader.className = 'modal-header bg-primary text-white';
    }
    const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
    resultsModal.show();
    {% endif %}

    // Allow both comma and dot as decimal separators
    const numericInputs = document.querySelectorAll('#density, #initial_height, #transfer_weight');
    
    numericInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            // Allow digits, dots, commas, and one decimal separator
            let value = e.target.value;
            
            // Replace comma with dot for internal processing
            value = value.replace(',', '.');
            
            // Remove any invalid characters except digits and one dot
            value = value.replace(/[^0-9.]/g, '');
            
            // Ensure only one decimal point
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            e.target.value = value;
        });
        
        // Validate on blur
        input.addEventListener('blur', function(e) {
            const value = parseFloat(e.target.value);
            
            if (e.target.id === 'density') {
                if (value <= 0 || value > 5) {
                    alert('Плотность должна быть между 0.0001 и 5.0000 кг/л');
                    e.target.focus();
                }
            } else if (e.target.id === 'initial_height') {
                if (value < 0) {
                    alert('Текущая высота не может быть отрицательной');
                    e.target.focus();
                }
            } else if (e.target.id === 'transfer_weight') {
                if (value <= 0) {
                    alert('Вес откачки должен быть положительным числом');
                    e.target.focus();
                }
            }
        });
    });

    // Form validation
    document.getElementById('calibrationForm').addEventListener('submit', function(e) {
        const density = parseFloat(document.getElementById('density').value);
        const initialHeight = parseFloat(document.getElementById('initial_height').value);
        const transferWeight = parseFloat(document.getElementById('transfer_weight').value);

        if (isNaN(density) || density <= 0 || density > 5) {
            alert('Пожалуйста, введите корректную плотность (0.0001-5.0000 кг/л)');
            e.preventDefault();
            document.getElementById('density').focus();
            return;
        }

        if (isNaN(initialHeight) || initialHeight < 0) {
            alert('Пожалуйста, введите корректную текущую высоту (≥ 0 см)');
            e.preventDefault();
            document.getElementById('initial_height').focus();
            return;
        }

        if (isNaN(transferWeight) || transferWeight <= 0) {
            alert('Пожалуйста, введите корректный вес откачки (> 0 кг)');
            e.preventDefault();
            document.getElementById('transfer_weight').focus();
            return;
        }
    });
});
</script>
{% endblock %} 